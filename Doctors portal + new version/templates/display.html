<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PR Schedule - Doctors Schedule Portal</title>
  <link rel="stylesheet" href="/static/css/display.css" />
  <style>
    /* Added styles for dynamic per-day closure banner */
    #closureBanner{display:none;background:#b91c1c;color:#fff;padding:18px 20px;text-align:center;font-size:40px;font-weight:800;letter-spacing:1px;border-bottom:6px solid #f87171}
    #closureBanner.small{font-size:22px;padding:14px 16px}
    .legend{display:flex;gap:14px;font-size:12px;margin:10px 8px 0;color:#2f4d46;flex-wrap:wrap}
    .legend span{display:inline-flex;align-items:center;gap:4px}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .legend .on{background:#2e7d32}.legend .off{background:#b23b3b}.legend .leave{background:#ff9800}.legend .pending{background:#607d8b}.legend .call{background:#0288d1}
    /* Filter Bar */
    .filter-bar{display:flex;gap:12px;padding:14px 12px;background:rgba(255,255,255,0.95);border-radius:14px;margin:12px 12px 0;box-shadow:0 2px 8px rgba(0,95,84,0.08);flex-wrap:wrap;align-items:center}
    .filter-input{flex:1;min-width:200px;padding:10px 14px;border:2px solid #c0e0d5;border-radius:10px;font-size:14px;font-weight:500;color:#0d3028;background:#ffffff;transition:all 0.3s ease}
    .filter-input:focus{outline:none;border-color:#008574;box-shadow:0 0 0 3px rgba(0,133,116,0.1)}
    .filter-select{padding:10px 36px 10px 14px;border:2px solid #c0e0d5;border-radius:10px;font-size:14px;font-weight:600;color:#0d3028;background:#ffffff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23008574' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 12px center;cursor:pointer;appearance:none;transition:all 0.3s ease}
    .filter-select:focus{outline:none;border-color:#008574;box-shadow:0 0 0 3px rgba(0,133,116,0.1)}
    .filter-clear{padding:10px 20px;background:linear-gradient(135deg, #008574, #00a88e);border:none;border-radius:10px;color:#ffffff;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.25s ease;box-shadow:0 2px 8px rgba(0,133,116,0.2)}
    .filter-clear:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,133,116,0.3)}
    .filter-clear:active{transform:translateY(0)}
    @media(max-width:600px){.filter-bar{flex-direction:column;align-items:stretch}.filter-input,.filter-select,.filter-clear{width:100%}}
  /* Pending overlay message inside schedule block when no schedule yet */
  /* Unified status overlay (leave / sick / cancelled) */
  /* Overlay leaves header unobstructed using gradient fade starting below doc-head height */
  /* High-visibility badge overlay (no blur, no gradient) */
  .status-cover{position:absolute;top:58px;left:16px;right:16px;display:none;padding:10px 18px;font-size:16px;font-weight:800;letter-spacing:.6px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.25);pointer-events:none;white-space:normal;line-height:1.25;text-align:center;max-width:calc(100% - 32px);margin:0 auto}
  .status-cover.pending{background:#eceff1;color:#263238;border:2px solid #607d8b}
  .status-cover.leave{background:#ffb74d;color:#3e2723;border:2px solid #ff9800}
  .status-cover.sick{background:#ff8a80;color:#4a0d0d;border:2px solid #e53935}
  .status-cover.cancel{background:#ff5252;color:#ffffff;border:2px solid #d32f2f}
  .status-cover.offduty{background:#ffe082;color:#4a3000;border:2px solid #ffc107}
  .status-cover.oncall{background:#29b6f6;color:#062b3a;border:2px solid #0288d1}
  @media (max-width:900px){.status-cover{font-size:14px;padding:8px 12px;top:54px}}
  /* Card border highlight for status */
  .doc-row.status-flag{border:2px solid #ffb74d;border-radius:14px;position:relative}
  .doc-row.status-flag.status-cancel{border-color:#ef5350}
  .doc-row{transition:border-color .3s ease, transform .2s ease;cursor:pointer;user-select:none}
  .doc-row:hover{transform:translateY(-2px);filter:brightness(1.05)}
  .doc-row:active{transform:translateY(0)}
  @media (max-width:900px){.status-cover{font-size:16px;padding:14px 12px}}
  .status-cover .small{margin-top:6px;font-size:12px;font-weight:600;opacity:.8}
  </style>
</head>
<body class="flyer-bg">
  <!-- Dynamic per-day closure banner (JS controlled) -->
  <div id="closureBanner" aria-live="polite"></div>
  {% if closure and closure.active %}
  <div style="background:#b91c1c;color:#fff;padding:18px 20px;text-align:center;font-size:40px;font-weight:800;letter-spacing:1px;border-bottom:6px solid #f87171" id="todayServerClosure">
    {{ closure.reason }}
  </div>
  {% endif %}

  <header class="hero">
    <div class="brand-left">
      {% if display_logo %}
      <img id="logoImg" class="brand-logo" src="{{ display_logo }}?v={{ logo_version }}" alt="Hulhumale' Hospital" onerror="this.style.display='none'" />
      {% endif %}
      <div class="brand-text">Hulhumale' Hospital</div>
    </div>
  <h1>PR SCHEDULE</h1>
    <div class="date-nav">
      <button id="prevDateBtn" class="nav-arrow" title="Previous day" disabled aria-label="Previous day">&lt;</button>
      <span class="date-pill" id="dateDisplay">{{ today_str }}</span>
  <button id="nextDateBtn" class="nav-arrow" title="Next day" aria-label="Next day">&gt;</button>
    </div>
  </header>
  <div class="legend">
    <span><span class="dot on"></span>On Duty</span>
    <span><span class="dot leave"></span>Leave/Sick</span>
    <span><span class="dot call"></span>On Call</span>
    <span><span class="dot pending"></span>Pending</span>
  </div>
  
  <!-- Filter Controls -->
  <div class="filter-bar">
    <input type="text" id="doctorSearch" placeholder="üîç Search doctor name..." class="filter-input" />
    <select id="specialtyFilter" class="filter-select">
      <option value="">All Specialties</option>
      {% for spec in data.specialty_order %}
      <option value="{{ spec }}">{{ spec }}</option>
      {% endfor %}
    </select>
    <button id="clearFilters" class="filter-clear">Clear</button>
  </div>
  
  <main class="shell">
    <div class="spec-grid" id="specGrid">
      {% for spec in data.specialty_order %}
      <section class="specialty">
        <h2 class="spec-title">{{ spec }}</h2>
        <div class="rows">
          {% for d in data.doctors if d.specialty == spec %}
          <div class="doc-row {{ d.status|lower }}" data-id="{{ d.id }}" data-doctor-name="{{ d.name }}" data-specialty="{{ d.specialty }}" style="position:relative" role="button" tabindex="0" aria-label="View details for {{ d.name }}">
            <div class="text-col">
              <div class="doc-head">
                <div class="avatar-wrap">
                  <img class="avatar" src="/doctor-photo/{{ d.id }}?v={{ d.image_version }}" alt="Avatar" onerror="this.onerror=null;this.src='/static/img/default-doctor.png';this.alt='Avatar';" />
                </div>
                <div class="title-wrap">
                  <div class="name-pill" title="{{ d.name }}">{{ d.name }}</div>
                  <div class="sub">{{ d.specialty }}</div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endfor %}
    </div>
  </main>

  {% if contact_phone or contact_address %}
  <footer class="contact">
    <div class="badge">INFO & RESERVATION :</div>
    <div class="items">
      {% if contact_phone %}<div class="item">üìû {{ contact_phone }}</div>{% endif %}
      {% if contact_address %}<div class="item">üìç {{ contact_address }}</div>{% endif %}
    </div>
  </footer>
  {% endif %}

  <!-- Doctor Status Modal -->
  <div id="doctorStatusModal" class="status-modal" style="display:none">
    <div class="status-modal-backdrop"></div>
    <div class="status-modal-card">
      <div class="status-modal-header">
        <h3 id="modalDoctorName">Dr. Name</h3>
        <button class="status-modal-close" onclick="closeDoctorStatusModal()">‚úï</button>
      </div>
      <div class="status-modal-body">
        <div class="status-info-grid">
          <div class="status-info-item">
            <div class="info-icon">üè•</div>
            <div class="info-label">Specialty</div>
            <div class="info-value" id="modalSpecialty">-</div>
          </div>
          <div class="status-info-item">
            <div class="info-icon">üìã</div>
            <div class="info-label">Designation</div>
            <div class="info-value" id="modalDesignation">-</div>
          </div>
          <div class="status-info-item">
            <div class="info-icon">üïê</div>
            <div class="info-label">Starting Time</div>
            <div class="info-value" id="modalStartTime">-</div>
          </div>
          <div class="status-info-item">
            <div class="info-icon">üè™</div>
            <div class="info-label">Room</div>
            <div class="info-value" id="modalRoom">-</div>
          </div>
          <div class="status-info-item">
            <div class="info-icon">üìû</div>
            <div class="info-label">Token</div>
            <div class="info-value" id="modalToken">-</div>
          </div>
          <div class="status-info-item">
            <div class="info-icon">‚è∞</div>
            <div class="info-label">Breaks</div>
            <div class="info-value" id="modalBreaks">-</div>
          </div>
        </div>
        <div class="status-badge-large" id="modalStatus">
          <div class="status-icon">‚úì</div>
          <div class="status-text">Available</div>
        </div>
        <div class="status-note" id="modalNote" style="display:none">
          <div class="note-icon">üìù</div>
          <div class="note-text"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/display.js"></script>
  <script>
    window.displayConfig = { todayIso: '{{ today_iso }}', days: 14 };
    
    function closeDoctorStatusModal(){
      document.getElementById('doctorStatusModal').style.display = 'none';
    }
    
    function showDoctorStatus(docId){
      // Fetch doctor data and show modal
      const modal = document.getElementById('doctorStatusModal');
      fetch(`/api/doctors/${docId}`).then(r => r.json()).then(data => {
        document.getElementById('modalDoctorName').textContent = data.name || 'Unknown';
        document.getElementById('modalSpecialty').textContent = data.specialty || '-';
        document.getElementById('modalDesignation').textContent = data.designation || '-';
  // Format times as HH:MM (strip seconds)
  const fmt = (t)=> (t? String(t).replace(/\b(\d{1,2}):(\d{2})(?::\d{2})?\b/g, (_m,h,m)=>`${String(h).padStart(2,'0')}:${m}`) : '-');
  document.getElementById('modalStartTime').textContent = fmt(data.start_time);
        document.getElementById('modalRoom').textContent = data.room || '-';
        document.getElementById('modalToken').textContent = data.token || '-';
  document.getElementById('modalBreaks').textContent = (data.breaks && data.breaks.length) ? fmt(data.breaks.join(', ')) : '-';
        
        const statusBadge = document.getElementById('modalStatus');
        const noteDiv = document.getElementById('modalNote');
        const status = (data.status || 'ON').toUpperCase();
        
        statusBadge.className = 'status-badge-large status-' + status.toLowerCase();
        
        if(status === 'ON'){
          statusBadge.innerHTML = '<div class="status-icon">‚úì</div><div class="status-text">Available</div>';
          noteDiv.style.display = 'none';
        } else if(status === 'LEAVE'){
          statusBadge.innerHTML = '<div class="status-icon">üèñÔ∏è</div><div class="status-text">On Leave</div>';
          noteDiv.style.display = data.note ? '' : 'none';
          noteDiv.querySelector('.note-text').textContent = data.note || '';
        } else if(status === 'SICK'){
          statusBadge.innerHTML = '<div class="status-icon">ü§í</div><div class="status-text">Sick Leave</div>';
          noteDiv.style.display = data.note ? '' : 'none';
          noteDiv.querySelector('.note-text').textContent = data.note || '';
        } else if(status === 'CANCEL'){
          statusBadge.innerHTML = '<div class="status-icon">‚úñ</div><div class="status-text">Cancelled</div>';
          noteDiv.style.display = data.note ? '' : 'none';
          noteDiv.querySelector('.note-text').textContent = data.note || '';
        } else if(status === 'PENDING'){
          statusBadge.innerHTML = '<div class="status-icon">‚è≥</div><div class="status-text">Schedule Pending</div>';
          noteDiv.style.display = 'none';
        } else if(status === 'OFFDUTY'){
          statusBadge.innerHTML = '<div class="status-icon">üè†</div><div class="status-text">Off Duty</div>';
          noteDiv.style.display = 'none';
        } else if(status === 'ONCALL'){
          statusBadge.innerHTML = '<div class="status-icon">üìû</div><div class="status-text">On Call</div>';
          noteDiv.style.display = 'none';
        }
        
        modal.style.display = 'flex';
      }).catch(err => {
        console.error('Failed to load doctor data:', err);
      });
    }
    
    // Add click handlers to doctor rows
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.doc-row').forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => {
          const docId = row.getAttribute('data-id');
          if(docId) showDoctorStatus(docId);
        });
      });
      
      // Filter functionality
      const searchInput = document.getElementById('doctorSearch');
      const specialtyFilter = document.getElementById('specialtyFilter');
      const clearBtn = document.getElementById('clearFilters');
      
      function applyFilters(){
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedSpecialty = specialtyFilter.value;
        const isFiltering = searchTerm || selectedSpecialty;
        
        document.querySelectorAll('.specialty').forEach(section => {
          const sectionSpecialty = section.querySelector('.spec-title').textContent.trim();
          const rows = section.querySelectorAll('.doc-row');
          const rowsContainer = section.querySelector('.rows');
          let visibleCount = 0;
          
          rows.forEach(row => {
            const nameEl = row.querySelector('.name-pill');
            const doctorName = nameEl ? nameEl.textContent.toLowerCase() : '';
            
            const matchesSearch = !searchTerm || doctorName.includes(searchTerm);
            const matchesSpecialty = !selectedSpecialty || sectionSpecialty === selectedSpecialty;
            
            if(matchesSearch && matchesSpecialty){
              row.style.display = '';
              visibleCount++;
            } else {
              row.style.display = 'none';
            }
          });
          
          // Toggle filtered class for centering
          if(rowsContainer){
            if(isFiltering){
              rowsContainer.classList.add('filtered');
            } else {
              rowsContainer.classList.remove('filtered');
            }
          }
          
          // Hide section if no visible doctors
          section.style.display = visibleCount > 0 ? '' : 'none';
        });
      }
      
      if(searchInput) searchInput.addEventListener('input', applyFilters);
      if(specialtyFilter) specialtyFilter.addEventListener('change', applyFilters);
      if(clearBtn){
        clearBtn.addEventListener('click', () => {
          searchInput.value = '';
          specialtyFilter.value = '';
          applyFilters();
        });
      }
    });
  </script>
</body>
</html>
